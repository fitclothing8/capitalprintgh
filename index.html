<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="theme-color" content="#722f37" />
    <meta name="description" content="We Customize The Looks You Wear, While You Wear The Look You Wish! Discover unparalleled craftsmanship with our premium custom clothing and personalized fashion services. From bespoke tailoring to innovative designs, we create outfits that perfectly reflect your unique style and personality. Explore a world of fashion tailored just for you, where every detail is designed to turn heads and make lasting impressions. Experience the artistry of custom wear today!">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>capitalprint</title>
    <!--<base href="/" />-->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/app.css" />
    <link rel="stylesheet" href="/css/bootstrap.css" />
    <link rel="stylesheet" href="/css/bootstrap-grid.css" />
    <link rel="stylesheet" href="/css/bootstrap-reboot.css" />
    <link rel="stylesheet" href="/css/bootstrap-utilities.css" />
    <link rel="stylesheet" href="/css/allproducts.css" />
    <link rel="stylesheet" href="/css/design.css" />
    <link rel="stylesheet" href="/css/home.css" />
    <link rel="stylesheet" href="/css/MainLayout.css" />
    <link rel="stylesheet" href="/css/solution.css" />
    <link rel="manifest" href="manifest.webmanifest" type="application/manifest+json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <style>
        body {
            background: #222;
        }

        .loader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 190px;
            height: 20px;
            margin: auto;
        }

            .loader span {
                width: 2px;
                height: 20px;
                background-color: #e67e22;
                position: absolute;
                left: 0;
                transform-origin: center bottom;
                transform: rotate(-90deg);
                animation-name: load;
                animation-duration: 3s;
                animation-timing-function: ease;
                animation-iteration-count: infinite;
            }

                .loader span:nth-child(1) {
                    left: 9px;
                    animation-delay: 0.05s;
                }

                .loader span:nth-child(2) {
                    left: 18px;
                    animation-delay: 0.10s;
                }

                .loader span:nth-child(3) {
                    left: 27px;
                    animation-delay: 0.15s;
                }

                .loader span:nth-child(4) {
                    left: 36px;
                    animation-delay: 0.20s;
                }

                .loader span:nth-child(5) {
                    left: 45px;
                    animation-delay: 0.25s;
                }

                .loader span:nth-child(6) {
                    left: 54px;
                    animation-delay: 0.30s;
                }

                .loader span:nth-child(7) {
                    left: 63px;
                    animation-delay: 0.35s;
                }

                .loader span:nth-child(8) {
                    left: 72px;
                    animation-delay: 0.40s;
                }

                .loader span:nth-child(9) {
                    left: 81px;
                    animation-delay: 0.45s;
                }

                .loader span:nth-child(10) {
                    left: 90px;
                    animation-delay: 0.50s;
                }

                .loader span:nth-child(11) {
                    left: 99px;
                    animation-delay: 0.55s;
                }

                .loader span:nth-child(12) {
                    left: 108px;
                    animation-delay: 0.60s;
                }

                .loader span:nth-child(13) {
                    left: 117px;
                    animation-delay: 0.65s;
                }

                .loader span:nth-child(14) {
                    left: 126px;
                    animation-delay: 0.70s;
                }

                .loader span:nth-child(15) {
                    left: 135px;
                    animation-delay: 0.75s;
                }

                .loader span:nth-child(16) {
                    left: 144px;
                    animation-delay: 0.80s;
                }

                .loader span:nth-child(17) {
                    left: 153px;
                    animation-delay: 0.85s;
                }

                .loader span:nth-child(18) {
                    left: 162px;
                    animation-delay: 0.90s;
                }

                .loader span:nth-child(19) {
                    left: 171px;
                    animation-delay: 0.95s;
                }

                .loader span:nth-child(20) {
                    left: 180px;
                    animation-delay: 1.00s;
                }

        @keyframes load {
            to {
                transform: rotate(450deg);
            }
        }
        /* Keep animated text centered beneath */
        .animated-text {
            position: absolute;
            top: calc(50% + 100px); /* Positions text below the container */
            left: 50%;
            transform: translate(-50%, 0);
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            animation: colorChange 2s linear infinite;
        }

        /* Smooth color transition */
        @keyframes colorChange {
            0% {
                color: darkorange;
            }

            50% {
                color: white;
            }

            100% {
                color: darkmagenta;
            }
        }
    </style>

</head>
<body>
    <div id="app">
        <div class="loader">
            <span></span><span></span><span></span><span></span><span></span>
            <span></span><span></span><span></span><span></span><span></span>
            <span></span><span></span><span></span><span></span><span></span>
            <span></span><span></span><span></span><span></span><span></span>
        </div>
        <div class="animated-text">We Customize the look you Wear, While You Wear The Look You Wish...</div>
    </div>
    <button id="scrollToggleBtn" class="floating-btn">
        <i class="fas fa-arrow-down"></i>
    </button>

    <!-- Core libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Utility libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>

    <!-- Payment / Ads -->
    <script async src="https://js.stripe.com/v3"></script>
    <script src="js\prebid10.13.0.js"></script>
    <!-- Pan/Zoom -->
    <script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>

    <!-- Finally, Blazor bootstraps the app -->
    <script src="_framework/blazor.webassembly.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(reg => {
                    if (reg.active && reg.active.scriptURL.includes('serviceworker.js')) {
                        // Keep the current one
                        console.log('Active service worker retained:', reg.active.scriptURL);
                    } else {
                        // Unregister any others
                        reg.unregister().then(() => {
                            console.log('Old service worker unregistered:', reg.scope);
                        });
                    }
                });
            });
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/serviceworker.js')
                    .then((registration) => {
                        console.log(`Service Worker registered with scope: ${registration.scope}`);

                        // Check for service worker updates
                        registration.onupdatefound = () => {
                            const newWorker = registration.installing;
                            console.log('New Service Worker found, updating...');
                            newWorker.onstatechange = () => {
                                if (newWorker.state === 'activated') {
                                    console.log('New Service Worker activated. Consider refreshing!');
                                }
                            };
                        };
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    <!--this is the script  to runing invariable adds-->
    <script>
        var adUnits = [{
            code: 'banner-ad',
            mediaTypes: {
                banner: {
                    sizes: [[300, 250], [728, 90]]
                }
            },
            bids: [{
                bidder: 'selfHostedBidder',
                params: {
                    placementId: 'your-placement-id',
                    price: 0.10 // Minimum bid price in USD
                }
            }]
        }];

        pbjs.que.push(function () {
            pbjs.addAdUnits(adUnits);
            pbjs.requestBids({
                bidsBackHandler: function (bidResponses) {
                    console.log('Bid responses:', bidResponses);

                    let highestBid = getHighestBid(bidResponses);
                    if (highestBid) {
                        displayAd(highestBid); // Show ad first
                    }
                }
            });
        });

        function getHighestBid(bidResponses) {
            let bids = bidResponses['banner-ad']?.bids || [];
            return bids.length ? bids.reduce((max, bid) => bid.price > max.price ? bid : max, bids[0]) : null;
        }

        function displayAd(bid) {
            let adContainer = document.getElementById('banner-ad');
            adContainer.innerHTML = `<iframe src="${bid.adUrl}" width="300" height="250"></iframe>`;

            // Track when the ad is fully displayed (example: 10 seconds)
            setTimeout(() => {
                console.log("Ad fully watched. Processing payment...");
                processPayment(bid.price); // Charge advertiser after ad is watched
            }, 10000); // Adjust timing based on ad length
        }
    </script>
    <script>
        async function finalizePayment(clientSecret) {
            const stripe = Stripe("pk_live_i3F5mKKUq80vCt4beIEmEKk700wYYBkBF7"); // Replace with your actual Stripe Public Key

            const result = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: {
                        number: '4242424242424242',
                        exp_month: 12,
                        exp_year: 2025,
                        cvc: '123'
                    }
                }
            });

            if (result.error) {
                console.error("Payment failed:", result.error.message);
                return false;
            } else {
                console.log("Payment successful!");
                return true;
            }
        }
    </script>
    <script>
        async function compressImage(file) {
            try {
                const options = {
                    maxSizeMB: 0.8, // Slightly reduced for better optimization
                    maxWidthOrHeight: 1024, // Resize if needed
                    useWebWorker: true, // Improves performance
                    initialQuality: 0.7, // Ensures high quality while reducing size
                    fileType: file.type // Auto-detects file type
                };

                console.log(`Compressing image: ${file.name}, Size: ${(file.size / 1024 / 1024).toFixed(2)} MB`);

                const compressedFile = await imageCompression(file, options);

                console.log(`Compression complete: New Size: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);
                return compressedFile;
            } catch (error) {
                console.error("Image compression failed:", error);
                return null;
            }
        }

    </script>
    <script>
        document.getElementById("scrollToggleBtn").addEventListener("click", function () {
            const footer = document.querySelector("footer");
            const topBanner = document.querySelector(".top-banner");
            const icon = this.querySelector("i"); // Reference to the icon
            const isAtBottom = window.scrollY + window.innerHeight >= document.documentElement.scrollHeight;

            if (!isAtBottom) {
                footer.scrollIntoView({ behavior: "smooth" });
                icon.classList.remove("fa-arrow-down");
                icon.classList.add("fa-arrow-up"); // Change icon when scrolling down
            } else {
                topBanner.scrollIntoView({ behavior: "smooth" });
                icon.classList.remove("fa-arrow-up");
                icon.classList.add("fa-arrow-down"); // Change icon when scrolling up
            }
        });
    </script>

    <script>
        $(document).ready(function () {
            $('.dropdown-toggle').on('click', function () {
                $(this).next('.dropdown-submenu').toggle();
            });
        });
    </script>
    <script>
        function startCarouselForProducts() {
            // Your carousel initialization logic here.
            console.log("startCarouselForProducts");
        }
    </script>
    <script>
        function hideLoadingSpinner() {
            console.log("hideLoadingSpinner");
        }
    </script>
    <script>
        window.startChangingText = function (elementId, defaultText) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error(`Element with ID "${elementId}" not found.`);
                return;
            }
            // Use the defaultText as the first message.
            const messages = [
                defaultText,
                "Custom Designs for Every Occasion",
                "Quality, Creativity, and Style",
                "Your Brand, Our Passion"
            ];
            let messageIndex = 0;
            function updateText() {
                element.style.opacity = 0;
                setTimeout(() => {
                    element.textContent = messages[messageIndex];
                    element.style.opacity = 1;
                    messageIndex = (messageIndex + 1) % messages.length;
                }, 300);
            }
            updateText();
            setInterval(updateText, 3000);
        };
    </script>
    <script>
        let categorySliderStates = {}; // Stores carousels per subcategory
        let gridCarouselTimers = {}; // Keeps track of active grid carousel timers
        let modalSliderState = {}; // Separate tracking for manual navigation in modal
        let selectedProduct = null; // Tracks selected product

        // Function to initialize subcategory carousels
        function initializeCarousels(categoryProducts) {
            Object.entries(categoryProducts).forEach(([categoryName, subcategories]) => {
                Object.entries(subcategories).forEach(([subCategoryName, products]) => {
                    products.forEach(product => {
                        // Initialize each subcategory carousel tracking
                        if (!categorySliderStates[subCategoryName]) {
                            categorySliderStates[subCategoryName] = {
                                currentIndex: 0,
                                sliderProducts: products
                            };

                            // Start auto-carousel for subcategory product grid
                            gridCarouselTimers[subCategoryName] = setInterval(() => {
                                let state = categorySliderStates[subCategoryName];
                                state.currentIndex = (state.currentIndex + 1) % state.sliderProducts.length; // Cycle images

                                const productImage = document.querySelector(`#product-${product.Name} .product-img`);
                                if (productImage) {
                                    productImage.src = state.sliderProducts[state.currentIndex].ImageUrl; // Update image in grid
                                }
                            }, 3000); // Auto-slide every 3 seconds
                        }
                    });
                });
            });
        }
        // Function to open modal and STOP auto-carousel for that product
        function openModal(productName, subCategoryName) {
            selectedProduct = categorySliderStates[subCategoryName].sliderProducts.find(p => p.Name === productName);
            modalSliderState[productName] = { ...categorySliderStates[subCategoryName] }; // Copy state for manual navigation

            // Stop auto-carousel ONLY for this subcategory (grid carousel continues)
            if (gridCarouselTimers[subCategoryName]) {
                clearInterval(gridCarouselTimers[subCategoryName]);
            }
        }

        // Function to navigate manually inside modal
        function handleManualNavigation(direction) {
            if (!selectedProduct || !modalSliderState[selectedProduct.Name]) return;

            let state = modalSliderState[selectedProduct.Name];
            if (direction === 'prev') {
                state.currentIndex = (state.currentIndex - 1 + state.sliderProducts.length) % state.sliderProducts.length;
            } else if (direction === 'next') {
                state.currentIndex = (state.currentIndex + 1) % state.sliderProducts.length;
            }

            // Update modal content
            const modalImage = document.querySelector('.modal-image');
            const modalTitle = document.querySelector('.modal-title');
            const modalDescription = document.querySelector('.modal-description');
            if (modalImage && modalTitle && modalDescription) {
                modalImage.src = state.sliderProducts[state.currentIndex].ImageUrl;
                modalTitle.textContent = state.sliderProducts[state.currentIndex].Name;
                modalDescription.textContent = state.sliderProducts[state.currentIndex].Description;
            }
        }
        // Function to close modal and resume product grid carousel
        function closeModal(subCategoryName) {
            selectedProduct = null;

            // Resume subcategory carousel (NOT in modal)
            if (!gridCarouselTimers[subCategoryName]) {
                gridCarouselTimers[subCategoryName] = setInterval(() => {
                    let state = categorySliderStates[subCategoryName];
                    state.currentIndex = (state.currentIndex + 1) % state.sliderProducts.length;

                    state.sliderProducts.forEach(product => {
                        const productImage = document.querySelector(`#product-${product.Name} .product-img`);
                        if (productImage) {
                            productImage.src = state.sliderProducts[state.currentIndex].ImageUrl;
                        }
                    });
                }, 3000); // Auto-slide every 3 seconds
            }
        }
        // Example: Call `initializeCarousels(categoryProducts)` when page loads
    </script>
    <script>
        // Wrap everything so that functions are registered after the DOM loads.
        document.addEventListener("DOMContentLoaded", function () {

            // WhatsApp number (without the plus sign) and Imgbb API key
            const WHATSAPP_NUMBER = '233244736472';
            const IMGBB_API_KEY = '7d66cb3efc20cc0bd383710c214e0999';

            // Toggle popup visibility (keeps your design intact)
            function togglePopup(popupId, show) {
                const popup = document.getElementById(popupId);
                if (!popup) {
                    console.error(`Popup element '${popupId}' not found.`);
                    return;
                }
                popup.style.display = show ? "block" : "none";
            }

            // Expose open/close functions to global scope
            window.openOrderPopup = function () {
                togglePopup('orderPopup', true);
            };
            window.closeOrderPopup = function () {
                togglePopup('orderPopup', false);
            };

            // Helper to convert a Blob to a DataURL (wrapped in a Promise)
            function fileReaderToDataURL(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            // This is our main function that is invoked when the user clicks "Submit Order".
            window.captureModalAndSend = async function () {
                try {
                    // Get order details from the Order Popup
                    const size = document.getElementById('sizeSelect')?.value || "Not Specified";
                    const itemCount = document.getElementById('itemCount')?.value;
                    if (!itemCount || parseInt(itemCount, 10) < 1) {
                        alert("Please select a valid quantity!");
                        return;
                    }

                    // Retrieve product details from the Product Modal
                    const modalElement = document.getElementById('productModal');
                    if (!modalElement) {
                        console.error("Product modal not found!");
                        return;
                    }
                    const productName = document.querySelector('#productModal .modal-title')?.innerText || "CapitalPrint Products";
                    const productPrice = parseFloat(modalElement.getAttribute('data-price')) || 0;
                    const totalPrice = (productPrice * parseInt(itemCount, 10)).toFixed(2);

                    // Gather additional brand order details from the order table
                    let brandDetails = [];
                    document.querySelectorAll("#orderBrandTable tbody tr").forEach(row => {
                        brandDetails.push({
                            brand: row.querySelector(".brandSelect")?.value || "Not Specified",
                            type: row.querySelector(".typeSelect")?.value || "Not Specified",
                            size: row.querySelector(".sizeSelectBrand")?.value || "Not Specified",
                            quantity: row.querySelector(".quantityInput")?.value || "1"
                        });
                    });

                    // Capture the image from the Product Modal
                    const modalImageElement = document.getElementById('mainModalImage');
                    if (!modalImageElement) {
                        console.error("Modal image element not found!");
                        return;
                    }
                    const imageUrl = modalImageElement.src;
                    // Fetch the image data
                    const imageResponse = await fetch(imageUrl);
                    const blob = await imageResponse.blob();
                    const dataUrl = await fileReaderToDataURL(blob);
                    const base64Data = dataUrl.split(',')[1];

                    console.log("Uploading product image to Imgbb...");
                    // Prepare the data for Imgbb upload
                    const formData = new URLSearchParams();
                    formData.append('image', base64Data);

                    // POST to Imgbb
                    const imgbbResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    const imgbbResult = await imgbbResponse.json();
                    let uploadedImageUrl = "";
                    if (imgbbResult.success) {
                        uploadedImageUrl = imgbbResult.data.url;
                        console.log("Image uploaded successfully:", uploadedImageUrl);
                    } else {
                        console.error("Image upload failed", imgbbResult);
                    }

                    // Compose the WhatsApp message (include order details and image URL)
                    let whatsappMessage = `Hello! I would like to place an order.\n\nProduct: ${productName}\nSize: ${size}\nQuantity: ${itemCount}\nTotal Price: GHS ${totalPrice}\nDesign Image: ${uploadedImageUrl}`;
                    brandDetails.forEach((b, idx) => {
                        whatsappMessage += `\n\nOrder ${idx + 1}:\nBrand: ${b.brand}\nType: ${b.type}\nSize: ${b.size}\nQuantity: ${b.quantity}`;
                    });
                    const encodedMessage = encodeURIComponent(whatsappMessage);

                    // Determine the proper WhatsApp URL (using mobile protocol if needed)
                    let whatsappUrl;
                    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                        whatsappUrl = `whatsapp://send?phone=${WHATSAPP_NUMBER}&text=${encodedMessage}`;
                    } else {
                        whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
                    }

                    console.log("Navigating to WhatsApp:", whatsappUrl);
                    // Open WhatsApp in a new tab by simulating a click on an anchor element.
                    const anchor = document.createElement("a");
                    anchor.href = whatsappUrl;
                    anchor.target = "_blank";
                    anchor.rel = "noopener noreferrer";
                    document.body.appendChild(anchor);
                    anchor.click();
                    document.body.removeChild(anchor);

                } catch (error) {
                    console.error("Error processing order:", error);
                    alert("An error occurred while processing your order. Please try again.");
                }
            }; // end captureModalAndSend

        }); // end DOMContentLoaded
    </script>
    <script>
        // History management for undo/redo
        window.fabricHistory = [];
        window.fabricHistoryIndex = -1;

        window.fabricSaveHistory = () => {
            const json = window.fabricCanvas.toJSON();
            // If there are redo states, remove them
            if (window.fabricHistoryIndex < window.fabricHistory.length - 1) {
                window.fabricHistory.splice(window.fabricHistoryIndex + 1);
            }
            window.fabricHistory.push(json);
            window.fabricHistoryIndex = window.fabricHistory.length - 1;
        };

        window.fabricUndo = () => {
            if (window.fabricHistoryIndex > 0) {
                window.fabricHistoryIndex--;
                const prevState = window.fabricHistory[window.fabricHistoryIndex];
                window.fabricCanvas.loadFromJSON(prevState, window.fabricCanvas.renderAll.bind(window.fabricCanvas));
            }
        };

        window.fabricRedo = () => {
            if (window.fabricHistoryIndex < window.fabricHistory.length - 1) {
                window.fabricHistoryIndex++;
                const nextState = window.fabricHistory[window.fabricHistoryIndex];
                window.fabricCanvas.loadFromJSON(nextState, window.fabricCanvas.renderAll.bind(window.fabricCanvas));
            }
        };

        // Initialize the Fabric.js canvas with a background image.
        window.initializeFabricCanvas = (canvasId, baseImageUrl) => {
            const canvas = new fabric.Canvas(canvasId, {
                selection: true,
                preserveObjectStacking: true
            });
            fabric.Image.fromURL(baseImageUrl, (img) => {
                img.set({ originX: 'left', originY: 'top', selectable: false });
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                    scaleX: canvas.width / img.width,
                    scaleY: canvas.height / img.height
                });
                // Save the initial state.
                window.fabricSaveHistory();
            });
            window.fabricCanvas = canvas;
        };

        // Prompt image upload
        window.promptImageUpload = async () => {
            return new Promise((resolve) => {
                const input = document.createElement("input");
                input.type = "file";
                input.accept = "image/*";
                input.onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            });
        };

        // Fabric.js helper functions for adding objects.
        window.fabricAddImage = (imageDataUrl) => {
            fabric.Image.fromURL(imageDataUrl, (img) => {
                img.set({ left: 50, top: 50 });
                window.fabricCanvas.add(img);
                window.fabricSaveHistory();
            });
        };

        window.fabricAddText = (text) => {
            const fabricText = new fabric.IText(text, {
                left: 50,
                top: 100,
                fontSize: 30,
                fill: "black"
            });
            window.fabricCanvas.add(fabricText);
            window.fabricSaveHistory();
        };

        window.fabricAddShape = (color) => {
            const rect = new fabric.Rect({
                left: 100,
                top: 150,
                fill: color,
                width: 100,
                height: 100
            });
            window.fabricCanvas.add(rect);
            window.fabricSaveHistory();
        };

        // Fix for setting text color (check for both "i-text" and "text")
        window.fabricSetTextColor = (newColor) => {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject && (activeObject.type === "i-text" || activeObject.type === "text")) {
                activeObject.set("fill", newColor);
                window.fabricCanvas.renderAll();
                window.fabricSaveHistory();
            } else {
                alert("Please select a text object.");
            }
        };

        window.fabricApplyBlend = (blendMode) => {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject && activeObject.type === "image") {
                activeObject.set("globalCompositeOperation", blendMode);
                window.fabricCanvas.renderAll();
                window.fabricSaveHistory();
            }
        };
        window.fabricSetShapeColor = (newColor) => {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject && (activeObject.type === "rect" || activeObject.type === "circle" || activeObject.type === "triangle")) {
                activeObject.set("fill", newColor);
                window.fabricCanvas.renderAll();
                window.fabricSaveHistory();
            } else {
                alert("Please select a shape to change its color.");
            }
        };

        // Naive raw background removal using a threshold (assumes a light/white background)
        function removeBackgroundRaw(imageDataURL) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = function () {
                    const canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    const threshold = 240; // adjust this value for your specific background color
                    for (let i = 0; i < data.length; i += 4) {
                        // If R, G and B are near white, set alpha to 0 (transparent)
                        if (data[i] >= threshold && data[i + 1] >= threshold && data[i + 2] >= threshold) {
                            data[i + 3] = 0;
                        }
                    }
                    ctx.putImageData(imageData, 0, 0);
                    resolve(canvas.toDataURL("image/png"));
                };
                img.onerror = function (e) {
                    reject(e);
                };
                img.src = imageDataURL;
            });
        }

        // Spinner control functions (already available)
        function showSpinner() {
            const spinner = document.querySelector('.spinner');
            if (spinner) {
                spinner.style.display = 'flex';
            }
        }

        function hideSpinner() {
            const spinner = document.querySelector('.spinner');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }

        // Updated fabricRemoveBackground to use the raw background removal
        window.fabricRemoveBackground = async () => {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (!activeObject || activeObject.type !== "image") {
                alert("Please select an image to remove its background.");
                return;
            }

            // Get the image source from Fabric (assumed to be a data URL).
            const imageUrl = activeObject.getSrc();

            try {
                showSpinner(); // Show spinner before starting

                // Use our raw method to remove the background
                const newImageDataURL = await removeBackgroundRaw(imageUrl);

                // Update the Fabric canvas with the background-removed image.
                fabric.Image.fromURL(newImageDataURL, (img) => {
                    img.set({
                        left: activeObject.left,
                        top: activeObject.top,
                        scaleX: activeObject.scaleX,
                        scaleY: activeObject.scaleY
                    });
                    window.fabricCanvas.remove(activeObject);
                    window.fabricCanvas.add(img);
                    window.fabricCanvas.setActiveObject(img);
                    window.fabricCanvas.renderAll();
                    window.fabricSaveHistory();
                });
            } catch (error) {
                console.error("Error removing background:", error);
                alert("Failed to remove background. Please check the console for details.");
            } finally {
                hideSpinner(); // Hide spinner after done
            }
        };

        // Update thumbnail generation to disable image smoothing for sharper thumbnails
        function generateThumbnails(srcUrl) {
            var img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function () {
                var thumbDim = 150;

                // Create and configure canvas for first thumbnail
                var canvas1 = document.createElement("canvas");
                canvas1.width = thumbDim;
                canvas1.height = thumbDim;
                var ctx1 = canvas1.getContext("2d");
                ctx1.imageSmoothingEnabled = false;
                // Horizontal crop: take the top 1/3 of the image
                ctx1.drawImage(img, 0, 0, img.width, img.height / 3, 0, 0, thumbDim, thumbDim);
                var thumb1 = canvas1.toDataURL("image/jpeg");

                // Create and configure canvas for second thumbnail
                var canvas2 = document.createElement("canvas");
                canvas2.width = thumbDim;
                canvas2.height = thumbDim;
                var ctx2 = canvas2.getContext("2d");
                ctx2.imageSmoothingEnabled = false;
                // Vertical crop: take the right 1/3 of the image
                ctx2.drawImage(img, img.width - img.width / 3, 0, img.width / 3, img.height, 0, 0, thumbDim, thumbDim);
                var thumb2 = canvas2.toDataURL("image/jpeg");

                // Create and configure canvas for third thumbnail (scaled original)
                var canvas3 = document.createElement("canvas");
                canvas3.width = thumbDim;
                canvas3.height = thumbDim;
                var ctx3 = canvas3.getContext("2d");
                ctx3.imageSmoothingEnabled = false;
                ctx3.drawImage(img, 0, 0, img.width, img.height, 0, 0, thumbDim, thumbDim);
                var thumb3 = canvas3.toDataURL("image/jpeg");

                document.getElementById("thumb1").src = thumb1;
                document.getElementById("thumb2").src = thumb2;
                document.getElementById("thumb3").src = thumb3;
            };
            img.onerror = function (e) {
                console.error("Error loading image for thumbnails: " + srcUrl, e);
            };
            img.src = srcUrl;
        }

        // New CamanJS integration: Apply a vintage filter using CamanJS.
        window.camanApplyVintage = () => {
            const canvasElem = document.getElementById("fabricCanvas");
            Caman(canvasElem, function () {
                this.vintage();
                this.render(function () {
                    // Update Fabric's background with the filtered result.
                    const newDataUrl = canvasElem.toDataURL("image/png");
                    window.fabricCanvas.setBackgroundImage(newDataUrl, window.fabricCanvas.renderAll.bind(window.fabricCanvas), {
                        scaleX: window.fabricCanvas.width / this.canvas.width,
                        scaleY: window.fabricCanvas.height / this.canvas.height
                    });
                    window.fabricSaveHistory();
                });
            });
        };

        // Additional shape functions
        window.AddCircle = function () {
            const circle = new fabric.Circle({
                radius: 50,
                fill: 'blue',
                left: 100,
                top: 100
            });
            window.fabricCanvas.add(circle);
            window.fabricSaveHistory();
        };

        window.AddTriangle = function () {
            const triangle = new fabric.Triangle({
                width: 100,
                height: 100,
                fill: 'green',
                left: 150,
                top: 150
            });
            window.fabricCanvas.add(triangle);
            window.fabricSaveHistory();
        };

        window.AddLine = function () {
            const line = new fabric.Line([50, 100, 200, 200], {
                stroke: 'black',
                strokeWidth: 2
            });
            window.fabricCanvas.add(line);
            window.fabricSaveHistory();
        };

        // Toggle a grid overlay on the canvas
        let gridVisible = false;
        window.ToggleGrid = function () {
            if (gridVisible) {
                window.fabricCanvas.backgroundImage = null;
            } else {
                // Create a simple grid pattern using a canvas element
                const gridCanvas = document.createElement('canvas');
                gridCanvas.width = gridCanvas.height = 50;
                const ctx = gridCanvas.getContext('2d');
                ctx.strokeStyle = '#ccc';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(50, 0);
                ctx.moveTo(0, 0);
                ctx.lineTo(0, 50);
                ctx.stroke();
                window.fabricCanvas.setBackgroundColor({
                    source: gridCanvas,
                    repeat: 'repeat'
                }, window.fabricCanvas.renderAll.bind(window.fabricCanvas));
            }
            gridVisible = !gridVisible;
            window.fabricCanvas.renderAll();
        };

        // Fix Group objects so they remain visible
        window.GroupObjects = function () {
            const activeObjects = window.fabricCanvas.getActiveObjects();
            if (activeObjects && activeObjects.length > 1) {
                const group = new fabric.Group(activeObjects, { selectable: true });
                // Remove individual objects after grouping
                activeObjects.forEach(obj => window.fabricCanvas.remove(obj));
                window.fabricCanvas.add(group);
                window.fabricCanvas.setActiveObject(group);
                window.fabricSaveHistory();
                window.fabricCanvas.renderAll();
            }
        };

        window.UngroupObjects = function () {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject && activeObject.type === 'group') {
                const items = activeObject._objects;
                window.fabricCanvas.remove(activeObject);
                items.forEach(item => window.fabricCanvas.add(item));
                window.fabricSaveHistory();
                window.fabricCanvas.renderAll();
            }
        };

        // Bring Forward and Send Backward functions (if not visible add them to advanced tools)
        window.BringForward = function () {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject) {
                window.fabricCanvas.bringForward(activeObject);
                window.fabricCanvas.renderAll();
                window.fabricSaveHistory();
            }
        };

        window.SendBackward = function () {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject) {
                window.fabricCanvas.sendBackwards(activeObject);
                window.fabricCanvas.renderAll();
                window.fabricSaveHistory();
            }
        };

        window.ApplyMask = function () {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject) {
                activeObject.clipPath = new fabric.Rect({
                    width: activeObject.width / 2,
                    height: activeObject.height / 2,
                    originX: 'center',
                    originY: 'center',
                    left: activeObject.width / 4,
                    top: activeObject.height / 4
                });
                window.fabricCanvas.renderAll();
                window.fabricSaveHistory();
            }
        };

        // Enhanced Transform Tools - Simulated 3D transform via skew
        window.toggle3DMode = function () {
            const canvas = window.fabricCanvas;
            if (!canvas) {
                alert("Canvas not available.");
                return;
            }
            // If not already in 3D mode, activate it
            if (!canvas.__is3DModeEnabled) {
                const bg = canvas.backgroundImage;
                if (!bg) {
                    alert("No background image available.");
                    return;
                }
                // Save original background image source
                canvas.__bgOriginalUrl = (typeof bg.getSrc === "function") ? bg.getSrc() : null;
                // Remove the background image from canvas (it won't appear among objects)
                canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
                // Promote the background image as an object
                fabric.Image.fromURL(canvas.__bgOriginalUrl, function (bgImg) {
                    bgImg.set({
                        originX: 'center',
                        originY: 'center',
                        selectable: false
                    });
                    // Scale back to canvas size
                    bgImg.scaleToWidth(canvas.width);
                    // Collect all objects already on canvas
                    const objects = canvas.getObjects();
                    // Create a group with the promoted background and all canvas objects
                    const group = new fabric.Group([bgImg, ...objects], {
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        originX: 'center',
                        originY: 'center'
                    });
                    // Clear canvas and add the group
                    canvas.clear();
                    canvas.add(group);
                    canvas.__activeGroup = group;
                    canvas.__is3DModeEnabled = true;
                    canvas.renderAll();
                });
            } else {
                // Deactivate 3D mode: Ungroup to restore individual objects
                const group = canvas.__activeGroup;
                if (!group) {
                    return;
                }
                const objects = group._objects;
                group.destroy();
                canvas.clear();
                // Restore original background image
                if (canvas.__bgOriginalUrl) {
                    fabric.Image.fromURL(canvas.__bgOriginalUrl, function (bgImg) {
                        bgImg.set({
                            originX: 'left',
                            originY: 'top',
                            selectable: false
                        });
                        canvas.setBackgroundImage(bgImg, canvas.renderAll.bind(canvas), {
                            scaleX: canvas.width / bgImg.width,
                            scaleY: canvas.height / bgImg.height
                        });
                    });
                }
                // Add back the ungrouped objects
                objects.forEach(function (obj) {
                    canvas.add(obj);
                });
                canvas.__is3DModeEnabled = false;
                canvas.renderAll();
            }
        };
        // Disable 3D mode if it was enabled
        window.disable3DMode = function () {
            const canvas = window.fabricCanvas;
            if (canvas && canvas.__is3DModeEnabled) {
                // Call our existing toggle function to disable 3D mode
                window.toggle3DMode();
            }
        };

        window.flipHorizontal = function () {
            const canvas = window.fabricCanvas;
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.set('flipX', !activeObj.flipX);
                canvas.renderAll();
                window.fabricSaveHistory();
            }
        };

        window.flipVertical = function () {
            const canvas = window.fabricCanvas;
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.set('flipY', !activeObj.flipY);
                canvas.renderAll();
                window.fabricSaveHistory();
            }
        };

        window.rotateLeft = function () {
            const canvas = window.fabricCanvas;
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.rotate((activeObj.angle || 0) - 15);
                canvas.renderAll();
                window.fabricSaveHistory();
            }
        };

        window.rotateRight = function () {
            const canvas = window.fabricCanvas;
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.rotate((activeObj.angle || 0) + 15);
                canvas.renderAll();
                window.fabricSaveHistory();
            }
        };
        // Drawing and Freehand Features

        // Enable custom free-drawing brush with adjustable settings
        window.UseCustomBrush = function () {
            window.fabricCanvas.isDrawingMode = true;
            window.fabricCanvas.freeDrawingBrush = new fabric.PencilBrush(window.fabricCanvas);
            window.fabricCanvas.freeDrawingBrush.color = prompt("Enter brush color:", "red") || "red";
            window.fabricCanvas.freeDrawingBrush.width = parseInt(prompt("Enter brush width:", "5"), 10) || 5;
            alert("Drawing mode activated. To exit, disable drawing mode.");
        };
        // Disable custom brush mode
        window.disableCustomBrush = function () {
            if (window.fabricCanvas) {
                window.fabricCanvas.isDrawingMode = false;
                alert("Drawing mode disabled.");
            }
        };
        // Eraser tool - simulate erasing by setting the brush color to white
        window.UseEraser = function () {
            window.fabricCanvas.isDrawingMode = true;
            window.fabricCanvas.freeDrawingBrush = new fabric.PencilBrush(window.fabricCanvas);
            window.fabricCanvas.freeDrawingBrush.color = "#ffffff"; // assuming white background
            window.fabricCanvas.freeDrawingBrush.width = 20;
            alert("Eraser mode activated. To exit, disable drawing mode.");
        };

        // Filters and Effects

        // Apply grayscale filter to the active image
        window.ApplyFilter = function () {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                activeObject.filters = [new fabric.Image.filters.Grayscale()];
                activeObject.applyFilters();
                window.fabricCanvas.renderAll();
                window.fabricSaveHistory();
            }
        };

        // Open blend mode prompt and apply blend mode
        window.OpenBlendModes = function () {
            const mode = prompt("Enter blend mode (e.g., multiply, screen):", "multiply");
            if (mode) {
                const activeObject = window.fabricCanvas.getActiveObject();
                if (activeObject) {
                    activeObject.set("globalCompositeOperation", mode);
                    window.fabricCanvas.renderAll();
                    window.fabricSaveHistory();
                }
            }
        };

        // Pattern and Texture Application

        // Apply a pattern fill to a rectangular object
        window.ApplyPattern = function () {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject && activeObject.type === 'rect') {
                fabric.util.loadImage('https://via.placeholder.com/50', function (img) {
                    activeObject.set('fill', new fabric.Pattern({
                        source: img,
                        repeat: 'repeat'
                    }));
                    window.fabricCanvas.renderAll();
                    window.fabricSaveHistory();
                });
            }
        };

        // Template and Preset Integration

        // Load a pre-designed template (clears canvas and adds a background image)
        window.OpenTemplates = function () {
            if (confirm("Load a pre-designed template? This will clear your current canvas.")) {
                window.fabricCanvas.clear();
                fabric.Image.fromURL('/Images/template.png', function (img) {
                    img.set({ selectable: false });
                    window.fabricCanvas.setBackgroundImage(img, window.fabricCanvas.renderAll.bind(window.fabricCanvas));
                    window.fabricSaveHistory();
                });
            }
        };

        // Color Adjustment Tools placeholder
        window.OpenColorAdjustments = function () {
            alert("Color adjustment tools coming soon...");
        };
        // Delete selected object (already declared above, unchanged)
        window.DeleteSelectedObject = function () {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject) {
                window.fabricCanvas.remove(activeObject);
                window.fabricCanvas.renderAll();
                window.fabricSaveHistory();
            } else {
                alert("No object selected to delete!.");
            }
        };
        // Modify the cropping tool to allow full movement and scaling.
        window.EnableCropTool = function () {
            const activeObject = window.fabricCanvas.getActiveObject();
            if (activeObject && activeObject.type === 'image') {
                // Create a crop rectangle with full controls
                const cropRect = new fabric.Rect({
                    left: activeObject.left + 10,
                    top: activeObject.top + 10,
                    width: activeObject.width / 2,
                    height: activeObject.height / 2,
                    fill: 'rgba(0,0,0,0.3)',
                    selectable: true,
                    hasBorders: true,
                    hasControls: true,
                    lockScalingFlip: true
                });
                window.fabricCanvas.add(cropRect);
                window.fabricCanvas.setActiveObject(cropRect);

                // When crop rectangle is modified, crop the image.
                cropRect.on('modified', function () {
                    const cropOffsetX = cropRect.left - activeObject.left;
                    const cropOffsetY = cropRect.top - activeObject.top;
                    const croppedImage = new fabric.Image(activeObject.getElement(), {
                        left: cropRect.left,
                        top: cropRect.top,
                        width: cropRect.width,
                        height: cropRect.height,
                        cropX: cropOffsetX,
                        cropY: cropOffsetY,
                        selectable: true
                    });
                    window.fabricCanvas.remove(activeObject);
                    window.fabricCanvas.remove(cropRect);
                    window.fabricCanvas.add(croppedImage);
                    window.fabricCanvas.setActiveObject(croppedImage);
                    window.fabricCanvas.renderAll();
                    window.fabricSaveHistory();
                });
            } else {
                alert("Please select an image to crop.");
            }
        };
        // Zoom In and Zoom Out functions
        window.ZoomIn = function () {
            let zoom = window.fabricCanvas.getZoom();
            window.fabricCanvas.setZoom(zoom * 1.1);
            window.fabricCanvas.renderAll();
        };

        window.ZoomOut = function () {
            let zoom = window.fabricCanvas.getZoom();
            window.fabricCanvas.setZoom(zoom / 1.1);
            window.fabricCanvas.renderAll();
        };

        // Toggle 3D Mode: Promote/demote the background image to/from a movable object.
        window.Enable3DMode = function () {
            // Use an internal flag on the canvas to track 3D mode.
            if (window.fabricCanvas.__is3DModeEnabled) {
                // If already in 3D mode, remove the interactive background object.
                const bg3d = window.fabricCanvas.getObjects().find(obj => obj.id === "bg3d");
                if (bg3d) {
                    window.fabricCanvas.remove(bg3d);
                }
                // Optionally, restore the original background image.
                if (window.fabricCanvas.__bgOriginalUrl) {
                    fabric.Image.fromURL(window.fabricCanvas.__bgOriginalUrl, (img) => {
                        img.set({
                            originX: 'left',
                            originY: 'top',
                            selectable: false
                        });
                        window.fabricCanvas.setBackgroundImage(img, window.fabricCanvas.renderAll.bind(window.fabricCanvas), {
                            scaleX: window.fabricCanvas.width / img.width,
                            scaleY: window.fabricCanvas.height / img.height
                        });
                        window.fabricSaveHistory();
                    });
                }
                window.fabricCanvas.__is3DModeEnabled = false;
            } else {
                // If not in 3D mode, promote the background image into a selectable object.
                const bg = window.fabricCanvas.backgroundImage;
                if (!bg) {
                    alert("No background image available.");
                    return;
                }
                // Save original background URL so you can restore later.
                const bgUrl = (typeof bg.getSrc === "function") ? bg.getSrc() : null;
                if (!bgUrl) {
                    alert("Background image source not found.");
                    return;
                }
                window.fabricCanvas.__bgOriginalUrl = bgUrl;
                // Remove background image.
                window.fabricCanvas.setBackgroundImage(null, window.fabricCanvas.renderAll.bind(window.fabricCanvas));
                // Create a movable background image object.
                fabric.Image.fromURL(bgUrl, (img) => {
                    img.set({
                        left: 0,
                        top: 0,
                        selectable: true,
                        evented: true,
                        // Scale the image so it fits the canvas.
                        scaleX: window.fabricCanvas.width / img.width,
                        scaleY: window.fabricCanvas.height / img.height
                    });
                    // Tag the object so we can identify it later.
                    img.id = "bg3d";
                    // Add the object and send it to the back.
                    window.fabricCanvas.add(img);
                    img.sendToBack();
                    window.fabricCanvas.__is3DModeEnabled = true;
                    window.fabricCanvas.renderAll();
                    window.fabricSaveHistory();
                });
            }
        };
        // Capture and send image via WhatsApp (updated function)
        window.captureAndSendImage = async (canvasId, productName, selectedColor, price, itemCount, selectedSize) => {
            const canvasElem = document.getElementById(canvasId);
            const dataURL = canvasElem.toDataURL("image/png");
            console.log("Captured image data URL:", dataURL);

            // Upload the captured image to imgbb to obtain a URL.
            const IMGBB_API_KEY = '7d66cb3efc20cc0bd383710c214e0999';
            const formData = new URLSearchParams();
            formData.append('image', dataURL.split(',')[1]);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            let imageUrl = "";
            if (result.success) {
                imageUrl = result.data.url;
            } else {
                console.error("Image upload failed", result);
            }

            // Multiply the unit price by the quantity
            const totalPrice = (parseFloat(price) * parseInt(itemCount)).toFixed(2);

            const WHATSAPP_NUMBER = '+233244736472';
            const whatsappMessage = `Hello! I would like to place an order.\n\nProduct: ${productName}\nSize: ${selectedSize}\nQuantity: ${itemCount}\nTotal Price: GHS ${totalPrice}\nDesign Image: ${imageUrl}`;
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMessage)}`;
            window.open(whatsappUrl, '_parent');
        };
        window.captureAndUploadImage = async (canvasId) => {
            const canvasElem = document.getElementById(canvasId);
            const dataURL = canvasElem.toDataURL("image/png");
            console.log("Uploading captured image to Google...", dataURL);
            // Implement your Google API upload logic here.
        };
    </script>
    <style>
        /* General Popup Style */
        #orderPopup {
            display: none; /* Default hidden */
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -20%);
            width: 70%; /* Increased from 60% */
            max-width: 700px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #007bff;
            z-index: 9999;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

            /* Animation for Opening */
            #orderPopup.show {
                opacity: 1;
                transform: translate(-50%, -10%);
            }

            /* Animation for Closing */
            #orderPopup.hide {
                opacity: 0;
                transform: translate(-50%, -30%);
            }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #orderPopup {
                top: 10%;
                width: 90%;
                max-width: 90%;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            #orderPopup {
                top: 5%;
                width: 95%;
                padding: 12px;
            }

            /* Button Styles */
            .order-popup-btn {
                font-size: 0.8rem;
                padding: 7px 10px;
            }
        }

        /* Modal Overlay */
        .modal {
            z-index: 1040; /* Lower than popup */
        }

        /* Form Inputs */
        .form-control {
            font-size: 14px;
            padding: 8px;
            border-radius: 5px;
        }

        /* Responsive table for order brand */
        #orderBrandTable {
            display: block;
            overflow-x: auto;
        }

            #orderBrandTable table {
                width: 100%;
                min-width: 600px;
            }
    </style>
    <script>
        window.addEventListener("load", () => {
            setTimeout(() => {
                console.log("Running New Tag script...");

                // Locate all product items on the page
                const products = document.querySelectorAll(".product-item");
                console.log(`Found ${products.length} product items.`);

                products.forEach((product) => {
                    // Get the product name element
                    const productNameElement = product.querySelector(".description-heading");
                    // Try to get the new-tag element; if not found, create one.
                    let newTagElement = product.querySelector(".new-tag");
                    if (!newTagElement) {
                        newTagElement = document.createElement("span");
                        newTagElement.className = "new-tag";
                        // Optionally, style the new tag via inline style or CSS class.
                        newTagElement.style.backgroundColor = "red";
                        newTagElement.style.color = "white";
                        newTagElement.style.padding = "2px 5px";
                        newTagElement.style.marginLeft = "5px";
                        newTagElement.innerText = "New";
                        product.appendChild(newTagElement);
                    }

                    if (productNameElement && newTagElement) {
                        // Read the product name, trim spaces, and use lower-case for comparison
                        const productName = productNameElement.textContent.trim();
                        console.log(`Product name found: "${productName}"`);

                        // Check case-insensitively if "new" appears in the product name
                        if (productName.toLowerCase().includes("new")) {
                            newTagElement.style.display = "inline-block";
                            console.log(`Displayed "New" tag for: "${productName}"`);
                        } else {
                            newTagElement.style.display = "none";
                            console.log(`No "new" text in: "${productName}"`);
                        }
                    } else {
                        console.warn("Missing product name or new-tag element in", product);
                    }
                });

                // Save and load star ratings
                const stars = document.querySelectorAll(".star-rating input");
                stars.forEach((star) => {
                    // Load saved rating from localStorage
                    const savedRating = localStorage.getItem(star.name);
                    if (savedRating && star.value === savedRating) {
                        star.checked = true; // Restore the saved rating
                    }
                    // Save the rating on change
                    star.addEventListener("change", (event) => {
                        localStorage.setItem(event.target.name, event.target.value);
                    });
                });
            }, 1000); // 1-second delay to ensure all elements are rendered
        });
    </script>
    <script>
        function generateThumbnails(srcUrl) {
            var img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function () {
                var thumbDim = 150;

                // Horizontal crop: take the top 1/3 of the image
                var hCropWidth = img.width,
                    hCropHeight = img.height / 3;
                var canvas1 = document.createElement("canvas");
                canvas1.width = thumbDim;
                canvas1.height = thumbDim;
                var ctx1 = canvas1.getContext("2d");
                ctx1.drawImage(img, 0, 0, hCropWidth, hCropHeight, 0, 0, thumbDim, thumbDim);
                var thumb1 = canvas1.toDataURL("image/jpeg");

                // Vertical crop: take the right 1/3 of the image
                var vCropWidth = img.width / 3,
                    vCropHeight = img.height;
                var canvas2 = document.createElement("canvas");
                canvas2.width = thumbDim;
                canvas2.height = thumbDim;
                var ctx2 = canvas2.getContext("2d");
                ctx2.drawImage(img, img.width - vCropWidth, 0, vCropWidth, vCropHeight, 0, 0, thumbDim, thumbDim);
                var thumb2 = canvas2.toDataURL("image/jpeg");

                // Third thumbnail: the original image scaled down
                var canvas3 = document.createElement("canvas");
                canvas3.width = thumbDim;
                canvas3.height = thumbDim;
                var ctx3 = canvas3.getContext("2d");
                ctx3.drawImage(img, 0, 0, img.width, img.height, 0, 0, thumbDim, thumbDim);
                var thumb3 = canvas3.toDataURL("image/jpeg");

                document.getElementById("thumb1").src = thumb1;
                document.getElementById("thumb2").src = thumb2;
                document.getElementById("thumb3").src = thumb3;
            };
            img.onerror = function (e) {
                console.error("Error loading image for thumbnails: " + srcUrl, e);
            };
            img.src = srcUrl;
        }

        // When a thumbnail is clicked, update the main modal image
        function onThumbnailClick(element) {
            const mainImage = document.getElementById("mainModalImage");
            if (mainImage) {
                mainImage.src = element.src; // Replace the main image with the thumbnail's source
                mainImage.style.width = "100%"; // Ensure it matches the original size
                mainImage.style.height = "auto"; // Maintain aspect ratio
            }
        }

        // Optionally, if you want to generate the thumbnails automatically on page load:
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(function () {
                if (typeof thumbSrcFromServer !== "undefined") {
                    generateThumbnails(thumbSrcFromServer);
                }
            }, 500);
        });
    </script>
    <script>
        function openOrderPopup() {
            document.getElementById('orderPopup').style.display = 'block';
        }
    </script>
    <script>
        function closeWelcomePopup() {
            document.getElementById('welcomePopup').style.display = 'none';
            document.getElementById('screenOverlay').style.display = 'none';
        }
    </script>
    the scroll popupview
    <script>
        window.addEventListener('scroll', () => {
            const popup = document.getElementById('attentionPopup');
            if (window.scrollY > 300) {
                popup.classList.add('show');
            }
        });
    </script>
    <script>
        function closePopupAndScroll() {
            // Hide the popup
            document.getElementById('attentionPopup').style.display = 'none';

            // Scroll to the T-shirts section
            const target = document.getElementById('printed-tshirts');
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        }
    </script>
    <!-- Add the following at the end of Home.razor, e.g. after the welcome popup -->
    <style>
        /* Adjust order popup buttons and layout for flexibility and better visibility */
        #orderPopup .btn {
            padding: 5px 10px !important;
            font-size: 0.9em !important;
            margin: 5px !important;
        }

        #orderPopup .button-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }

        /* Ensure table remove button is also small */
        #orderPopup .order-brand-row button.btn {
            padding: 3px 8px;
            font-size: 0.85em;
        }
    </style>
    <!-- JS Functions to enable buttons in the order popup -->
    <script>
        function closeOrderPopup() {
            document.getElementById('orderPopup').style.display = 'none';
        }

        function captureModalAndSend() {
            // Simulate order submission (replace with actual logic as needed)
            alert("Order submitted!");
            closeOrderPopup();
        }

        function addOrderBrandRow() {
            var table = document.getElementById('orderBrandTable');
            var tbody = table.querySelector('tbody');
            var lastRow = tbody.rows[tbody.rows.length - 1];
            var newRow = lastRow.cloneNode(true);
            // Reset form fields in the new row
            newRow.querySelectorAll('select, input').forEach(function (elem) {
                if (elem.tagName.toLowerCase() === 'select') {
                    elem.selectedIndex = 0;
                } else {
                    elem.value = elem.type === 'number' ? 1 : '';
                }
            });
            tbody.appendChild(newRow);
        }

        function removeRow(btn) {
            var row = btn.parentNode.parentNode;
            var tbody = row.parentNode;
            if (tbody.rows.length > 1) {
                tbody.removeChild(row);
            } else {
                alert("At least one row is required.");
            }
        }
    </script>
    <!-- jQuery code to rotate subcategory images -->
    <script>
        $(document).ready(function () {
            $('.subcategory-img').each(function () {
                var $img = $(this);
                var images = $img.data('products').split(',').map(function (url) { return url.trim(); });
                var names = $img.data('names').split(',').map(function (txt) { return txt.trim(); });
                var descriptions = $img.data('descriptions').split(',').map(function (txt) { return txt.trim(); });
                var prices = $img.data('prices').split(',').map(function (price) { return price.trim(); });
                var index = 0;
                var $details = $img.closest('.subcategory-item').find('.product-details');

                setInterval(function () {
                    index = (index + 1) % images.length;
                    $img.fadeOut(300, function () {
                        $img.attr('src', images[index]).fadeIn(300);
                        // Update the product details along with the image
                        $details.find('.description-heading').text(names[index]);
                        $details.find('.description').text(descriptions[index]);
                        $details.find('.product-price').html('<strong>Price:</strong> GHS ' + prices[index]);
                    });
                }, 3000);
            });
        });
    </script>
    <style>
        .fade {
            transition: opacity 1s ease-in-out;
            opacity: 1;
        }

        .fade-out {
            opacity: 0;
        }
    </style>
    <!-- Responsive Styles for Welcome Popup -->
    <style>
        @media (max-width: 600px) {
            #welcomePopup {
                width: 90%;
                max-width: 90%;
                padding: 10px;
            }

            #welcomeHeader {
                font-size: 1rem;
                padding: 8px;
            }

            #welcomeBody {
                padding: 15px;
            }

            #welcomeButtons {
                flex-direction: column;
                padding: 10px 0;
                gap: 5px;
            }

                #welcomeButtons button {
                    padding: 8px 10px;
                    font-size: 0.9rem;
                    width: 100%;
                    max-width: 300px;
                }

            #welcomeFooter {
                font-size: 0.8rem;
                padding: 8px;
            }
        }
    </style>
    <style>
        /* Responsive adjustments for the combined section */
        @media (max-width: 800px) {
            #combined-section {
                flex-direction: column;
            }

            #support-section, #pricing-section {
                width: 100%;
            }
                /* Optionally reduce text size further */
                #support-section h4, #pricing-section h3 {
                    font-size: 0.9rem;
                }
        }
    </style>
</body>

</html>
